# 【质点弹簧实现】如何做一个绝对不会崩溃的质点弹簧模型

在绳索、布料、软体等软性物质的模拟上，质点弹簧绝对是最流行的一种物理模型，相关资料在网上非常多。但无一例外的都绕不过一个痛点：动不动就崩溃给你看。那有没有一种能实现绝对不会崩溃的质点弹簧模型，或者说我们能始终确切的知道它崩溃的边缘在哪里，而不是和传统质点弹簧模型一样，总是在调参。

## 细数传统质点弹簧的三宗罪

传统质点弹簧为什么那么容易崩溃？其实总结起来就那几个原因：

- 迭代时间没设置好
- 弹力系数没设置好
- 弹簧阻力没设置好

我们当然可以说这是质点弹簧模型精密性的表现，但换句话说，它是不是太脆弱了？而且这三个系数真的很抽象，我们只能大概描述它们的作用，却不能精准预判它们的效果：

- 迭代时间太长：崩溃给你看；迭代时间太短：电脑带不动。
- 弹力系数太大：崩溃给你看；弹力系数太小：软塌塌的没劲。
- 弹簧阻力太小：崩溃给你看；弹簧阻力太大：崩溃给你看。

说到底，这三个参数就引发崩溃的陷阱，是传统质点弹簧无法解决的痛点。想要根除崩溃，办法就是彻底去除这三个家伙。当然，彻底去除是不可能的，因为它们同时也是质点弹簧的关键参数，但我们有很多巧妙的方式，可以将他们完全无害化。

## 去除迭代时间

迭代时间是真的可以去除，因为我们实际上有不依赖时间的位置积分方式。

### 确定质点位置的积分方式

总所周知质点弹簧模型里一般也就两种实现质点位置积分方式：

- 欧拉积分：$p(t+\Delta t)= p(t) + v(t)\Delta t + a(t)\Delta t^2$（这里用常见的半隐式欧拉）
- Verlet 积分：$p(t+\Delta t) = p(t)+(p(t)-p(t-\Delta t))+a(t)\Delta t^2$

可以观察到与位移有关项基本都依赖 $\Delta t$，但很巧的是 Verlet 积分中的第二项 $p(t)-p(t-\Delta t)$ 却是与时间无关。而由于加速度实际上可以转换为位移，所以我们可以使 $a(t)$永远等于 0，因此第三项我们是完全可以去除的。

划下来我们便能得到一种特别的位置积分方式，一种与时间完全无关的方法：

$$p(t+\Delta t) = p(t)+(p(t)-p(t-\Delta t))$$

这里的 $p(t)-p(t-\Delta t)$ 其实对应的就是欧拉积分中的 $v(t)\Delta t$，虽然具体数值和含义不同，但效果是一样的，因此后续我们将这一项也简称为“速度”。

### 确定力对质点的作用入口

该公式中提供了我们两个影响质点的入口：

- $p(t)$（当前位置）
- $p(t-\Delta t)$（上次位置）

修改上次位置显然不太适合，因为这会使其含义与实际值不匹配，例如如果后续要做 ccd（连续碰撞检测），这个本应该可以用上的参数就完全废掉了。

那便只能**修改当前位置**了。从公式的效果上来看，这样的结果就相当于力使质点立即发生的位移，并将速度累计了下来（当前位置和上次位置差值变化了）。

（此外这还隐藏了一些额外的好处，我们后续再说。）

### 确定质点位置积分的时序

传统的积分方式是在质点当前的所有力都施加完毕后，即每帧的末尾再对质点的位置进行积分。但该积分流程如果用在我们的积分方案上就会存在问题，因为我们是每次施加力后立即位移，然后累加下速度，接着积分通过速度再次位移，算下来一帧就位移了两次，即多了一次。

所以我们需要调整积分时序，**在每帧的开头时进行积分**，释放上一帧累加的速度，而后续的力计算，因为是直接作用于位移，因此也不依赖位置积分。

（此外这种迭代方式还隐藏了一些其他好处，我们后续再说。）

### 总结

新的质点弹簧模型，我们将使用如下方式迭代质点：


1. 每帧开始时对质点积分，积分方式采用：$$p(t+\Delta t) = p(t)+(p(t)-p(t-\Delta t))$$

```
帧开始
1. 对质点位置积分， p(t)+(p(t)-p(t-\Delta t))

帧结束
```

接下来我们要使用

## 去除弹力系数



## 去除弹簧阻力
