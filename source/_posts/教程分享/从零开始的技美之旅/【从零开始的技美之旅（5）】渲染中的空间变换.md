# 【从零开始的技美之旅（5）】渲染中的空间变换

GPU渲染管线中，我们只要知道如何在屏幕上画画就行，在一个2D坐标系上表示2D物体是很简单的。但在引擎渲染管线中，为了在屏幕上显示一个仿真的游戏世界，该任务就变成了如何将3D画面，映射到2D屏幕中。

## 渲染中的空间坐标系

- [详解：【技术美术】渲染管线空间变换](../../个人研究/技术美术/矩阵变换/【技术美术】渲染管线空间变换.md)
- [详解：【技术美术】投影矩阵和线性深度推导](../../个人研究/技术美术/矩阵变换/【技术美术】投影矩阵和线性深度推导.md)

### 物体空间

在游戏引擎中，顶点不再是屏幕空间，而是基于物体空间的，物体空间就是以物体自身为世界原点的坐标系。因为游戏中，大部分物体是复用的，或需要实时变换的，所以建模师都是以物体为单位来建模，自然的这样建出来的模型顶点，都是以模型的原点为基点。

### 世界空间

由于模型本身的顶点是不考虑其他物体的，但物体间的交互、相对位置是存在的，因此需将其统一到一个新的空间坐标系，即“世界空间”，这样子才能批量统一的处理网格数据，并使不同物体间的数据可以互通。

### 视图空间

游戏是仿真的，有了被观察的物体，自然需要观察他们的眼睛，而视图空间就是以眼睛为坐标系的空间。因为最终的屏幕画面是相对眼睛的，所以需要将所有物体先转到视图空间，然后才能方便的转换到裁剪空间。

### 剪辑空间

剪辑空间和NDC空间从数学上看本质是同一种，只是前者是基于齐次坐标的，后者则是齐次坐标归一化的结果。齐次坐标主要是为了兼容深度测试、以及TRS矩阵，使顶点可以很方便的实现位移、深度除法等计算。

### NDC空间

NDC空间就是前文讲到的GPU中的“2D”空间坐标系（当然他实际上是3D的，有一个额外的z轴来实现深度测试的功能），它相当于是最终的屏幕空间坐标系。NDC空间根据图形引擎的不同，其设定也不一样。

Unity中默认是以OpenGL为标准的，故 3 轴默认状态的定义如下：

- x轴：从左到右为 (-1,1)
- y轴：从下到上为 (-1,1)
- z轴：从近到远为 (0,1)

不过这些仍然会有例外情况。

#### z轴翻转

在D3D平台，z轴是01翻转的，即从近到远为 (1,0)。越近的z越大，越远的z越小，这很反直觉，不过这种翻转的深度可以更好的利用浮点数的分布情况，所以被广泛使用。在Unity中可以使用`UNITY_REVERSED_Z`来判断是否是翻转z轴的平台。

#### y轴翻转

在D3D平台，如果在片段着色器使用NDC坐标，会发现y轴是翻转的，为什么？

这和Unity读写纹理的方式有关，因为除了NDC空间，哪怕纹理坐标在不同图形接口下也是不一致的，OpenGL中纹理空间以左下角为零点，而D3D中以左上角为原点。那为什么在Unity中我们一直都是直接用OpenGL的方式读写纹理，却不会导致颠倒？

因为Unity在D3D平台会故意颠倒存储纹理。这种方式同样应用于渲染纹理，正好渲染纹理无论是作为材质输入，还是复制到屏幕，使用时都要进行采样，颠倒存储加颠倒采样，负负得正反而对了。

因此如果你在着色器里半路截胡，就会发现Unity为了颠倒存储而翻转了y轴。对于翻转y轴的平台，同样也可以利用对应的宏 `UNITY_UV_STARTS_AT_TOP` 来判断。
