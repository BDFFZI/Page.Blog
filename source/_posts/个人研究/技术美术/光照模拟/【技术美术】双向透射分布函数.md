---
categories:
  - 个人研究
  - 技术美术
  - 光照模拟
abbrlink: 3105478131
---
# 【技术美术】双向透射分布函数

透射部分的实现，网上资料很少，因此只能根据个人经验进行推导了。

主流的光照模型基于反射，反射分漫反射和镜面反射，而透射也同样可以定义为两种：

- 漫透射：指透射光穿越介质时经过了多次弹射最终均匀的从背面射出的光。（和漫反射一样，方向信息变的无意义）
- 镜透射：未经过多弹射，基本保持原方向，像折射一样从正背后射出的光。（和镜反射一样，方向信息会影响光照）

## 透射光的来源

透射光是从物体内射出的光，但物体不会无缘无故的发光，那它的源头究竟在哪？

### 从反射到透射

首先从双向反射分布函数考虑，“漫反射”和“镜反射”中，“镜反射”是一次接触直接反射，故肯定不会进入物体内部，但“漫反射”是在物体内部多次弹射的结果，因此显然它是有机会发生“透射”的。所以可以确定，如果发生透射，那它一定是从“漫反射”中分来的。

### 从漫反射到散射

根据次表面散射一章的知识，我们可知，漫反射中没有理由，入射位置和出射位置就一定是相同的，对于半透明物体，漫反射将升级为散射。

实现散射的方法很简单，其实就是重映射，例如半兰伯特、预计算的LUT，都是试图将反光区域扩展到背面。因此透射作为散射现象的一种，也同样是对漫射的重映射或重分配实现。

只是相比之下，透射对漫射的重分配更加极端，会使正背面的光比侧面光更强，这是如半兰伯特之类所不具备的。

## 漫透射

漫透射的光照类似漫反射，同样是无关观察方向的计算，故只要实现对旧漫反射的重映射即可。

漫透射的映射函数，不再是单调递减的，而是在正背面时还会有个单调递增的过程，从而实现类似碗装的结构。

![散射强度映射函数](../../../../assets/images/image-15.png)

通过缩放 $\cos$ 函数就可以很容易的找到一个符合条件的函数： $\cos(2x) * 0.5 + 0.5$，不过该函数不利于用点乘计算，所以可以利用三角函数将其转换为另一种表达方式：

$$(2 cos^2{x}-1)*0.5+0.5$$

其中 $cos(x)$ 其实就是指 `dot(n,l)`，于是代码就很容易实现出来了。

```hlsl
float scatterTerm = (2 * pow(dot(n, l), 2) - 1) * 0.5 + 0.5;
```

就像“漫反射”和“镜反射”有金属度进行权重分配一样，那“漫反射”和“漫透射”之间的光能权重分配，也需要一个属性，就叫它“透射率”吧。

```hlsl
//直接漫射
float diffuseTerm = max(0.0f, dot(light.direction, normalWS));
float3 diffuseLightTerm = light.color * light.distanceAttenuation * light.shadowAttenuation;
color += diffuseTerm * diffuseLightTerm * (1 - _Transmittivity);

//直接透射
float3 backLightDir = -normalize(light.direction + fragment.normalWS * _Disturbance);
float transmitTerm = saturate((dot(backLightDir, viewDirWS) + _Range) / (1 + _Range));
transmitTerm = pow(transmitTerm, _Power) * _Scale;
float3 transmitLightTerm = light.color * light.distanceAttenuation;
float thickness = tex2D(_Thickness, fragment.texcoord);
color += transmitTerm * transmitLightTerm * thickness * _Transmittivity;
```

## 镜透射

仅透射约等于透明，不考虑光照物理的话，有两种方法：

1. 把背景图保存下，直接用折射采样就行（类似于环境镜射光用反射采样环境贴图）。
2. 直接给物体搞个半透明材质。
