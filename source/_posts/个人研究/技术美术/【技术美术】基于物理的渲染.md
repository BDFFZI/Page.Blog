---
categories:
  - 个人研究
  - 技术美术
abbrlink: 2677748470
---

# 【技术美术】基于物理的渲染

基于物理的渲染本质任然是对现实光照的近似，但由于其基于物理规律，因此效果比传统的经验光照模型要好很多，且参数也更统一。

## 三要素

一个光照模型能被称为是基于物理的渲染，通常需要满足三个条件：

- 基于微表面模型。
- 遵循能量守恒。
- 使用基于物理的 BRDF。

### 微表面模型

微表面模型采用了微分的思想看待物体表面。无论表面是粗糙还是光滑，只要从足够小的尺度下观察，它们都是由一堆微小镜面构成的，因此物体表面的每一点都可以采用相同的光照计算公式。

### 能量守恒

物体表面反射光的总量一定小于等于入射光的总量。镜射光越多，漫射光越少；反射光斑越大，反射光亮度越低。

### 基于物理的 BRDF

BRDF 直译为双向散射分布函数，是一种解释光反射强度的模型。双向散射是指其将反射光描述为由镜射光和漫射光两种。基于物理的 BRDF 说明该公式不能是传统的经验模型，而是遵循各种物理现象而设计的模型。

## 反射率方程

反射率方程描述了反射光和入射光之间的关系：

$$
L_o(p,w_o)=\int_\Omega f_r(p,w_i,w_o)L_i(p,w_i)(n\cdot w_i)dw_i
$$

- 微分立体角：角的三维类比，表示球面上的矩形区域，微分说明该区域面积极其微小。（有时也会表示面方向，因此可以被点乘）
- $w_i$：到光源方向的微分立体角（入射方向）。
- $w_o$：到观察方向的微分立体角（反射方向）。
- $L_i(p,w_i)$：代表当前位置和面积受到的入射光。
- $n\cdot w_i$：表面接收的光强与入射光和表面法线夹角有关。
- $f_r$：BDRF（双向反射分布函数）。

该公式是基于“辐射度量学”得出的。

- 辐射功率：光的每时间做工能量。
- 辐射强度：光在每单位立体角上的辐射功率。
- 辐照度（Irradiance）：每单位面积受到的辐射强度。
- 辐射率（Radiance）：每单位垂直面积受到的辐射强度。

对应到反射率方程中为：

- $Irradiance = L_i(p,w_i)$
- $Radiance = Irradiance * (n\cdot w_i)$

转换到具体实现中，可解释为如下公式：

$$
L_o = \sum_{m} f_r * i_{m}*(N \cdot L_m)
$$

- $m$：逐灯光遍历
- $i_m$：受到的灯光强度
- $N$：物体表面法线。
- $L_m$：表面到灯光的方向。

## CookTorrance

CookTorrance 是最常用的基于物理的 BDRF，相比过去的一些经验模型，它的效果更加真实，符合物理规律。CookTorrance 中有很多过去 Lambert 和 Phong 的影子，可以说就是由它们为基础慢慢发展出的新时代光照模型，也是目前主流的光照模型。

### 基本公式结构

基本的 CookTorrrance 光照模型结构如下：

$$
CookTorrance = k_d * f_d + k_s * f_s
$$

- $k_d$：表面对每单位漫射光的反射率。
- $k_s$：表面对每单位镜射光的反射率。
- $f_s$：漫射系数，表示有多少光会被漫射进入进眼睛。
- $f_s$：镜射系数，表示有多少光会被直接反射进眼睛。

### 反射率计算

漫射和镜射的反射率的分配是根据物体表面的基本反射率（表面颜色）和金属度决定的，同时为了确保能量守恒，$k_d+k_s=1$。

$$k_d = (1-metallic) * 0.96$$
$$k_s = 1- k_d$$

- albedo（反射率）：决定了反射光的基本颜色强度信息（可简单理解为物体表面颜色）。
- metallic（金属度）：控制漫射光和镜射光之间的比例，以及镜射光颜色。金属度越高，漫射越少，镜射越多，镜射颜色越接近物体表面颜色。

0.96是标准介电镜面反射，一个定义了最大漫射比的常量，不清楚来源（应该是某种物理规则），其表明物体不可能总是吸收所以光，因此一定会发出一点镜射光。

### 漫射系数计算

$$
f_d = \frac{albedo}{\pi}
$$

其中 $\pi$ 是为了归一化，使其光亮的总和符合能量守恒，但有些地方（如 Unity）会故意去掉该项。

### 镜射系数计算

镜射系数的计算公式如下：

$$
f_s = \frac{D*G*F}{4(N \cdot L)(N \cdot V)}
$$

- $N$：法线方向
- $L$：光源方向
- $V$：相机方向

其中 D、G、F 是三个可插拔的系数，用于反应 3 种物理现象。可插拔意味着它们是可以更换的，有多种计算方式可供选择，因此可以以此实现渲染效果的定制。

此外 D、G 的计算依赖一个新的系数叫粗糙度，粗糙度可以通过物体表面的光滑度计算得出：

$$a = (1-smoothness)^2$$

- smoothness（光滑度）：控制镜射光的形状特征。

*在部分资料中该公式的分母系数 $(N \cdot L_m)_(N \cdot V)$ 可能会被去除，因为这部分可以被 $G$ 中的分子约分。但如果不去除的话，可以确保 $G \in [0,1]$，直观上看，这样会更能表现公式的物理效果。*

#### 法线分布

D 描述表面法线分布情况，具体而言它决定了镜面高光的光斑形状。下述是使用 GGX 计算 D 的方法：

- $H=\operatorname{normalize}(L+V)$：半角向量的缩写。

$$
D_{GGX} = \frac{a^2}{\pi((H\cdot N)^2(a^2-1)+1)^2}
$$

其中 $\pi$ 是为了归一化，使其光亮的总和符合能量守恒，但有些地方（如 Unity）会故意去掉该项。

#### 几何遮蔽

G 用于表现微表面之间的遮挡导致的光线衰减现象，这在粗糙的表面尤为明显。下述是使用 Smith 计算 G 的方法：

$$
G_{Smith} = \frac{(N \cdot L)}{lerp(N \cdot L,1,k)} *\frac{(N \cdot V)}{lerp(N \cdot V,1,k)}
$$

$$
k=\frac{(a+1)^2}{8}（直接光） 或 \frac{a^2}{2}（间接光）
$$

从中可以观察到:

- 光线入射角或观察角度与表面越垂直，光线被遮挡的概率越小。
- 越光滑的表面，光线被遮挡的概率越小。
- 对于直接光始终会被吸收一部分，而环境光可以全反射。

此外还有一种效果接近，但性能更好的方法：

$$
G_{SKSm}=\frac{(N \cdot L)(N \cdot V)}{lerp((L \cdot H)^2,1,a)}
$$

#### 菲涅尔效应

F 表示一个 0-1 的光线反射率，反应的是现实中的菲涅尔效应，描述了不同折射率的物体在不同观察角度下反射光线不同的特点。一般它的公式采用如下近似值：

$$
F = lerp((1-(V \cdot N))^5,1,F_0)
$$

$$
F_0 = \frac{(r-1)^2}{(r+1)^2}
$$

- $F_0$：法向反射率。
- $r$：折射率。

从中可以观察到以下几种现象：

- 折射率越高，菲涅尔效应越明显（如水面）。
- 菲涅尔效应发生时，物体正面反射光线少（能透过湖面看到底），掠角反射光线多（湖面变不透明）。
- 折射率为 0，没有菲涅尔效应，发生全反射。

不过上述菲涅尔公式只能用于透明物体，因为它会使物体表面反射为 0。对于不透明物体，可以需要采用另一种系数计算方法：

$$F_0 = \operatorname{lerp}(0.04,albedo,metallic)$$

不过该方法将菲涅尔函数的输出由标量改为了向量，且携带了镜射光的反射率信息，因此要修改 CookTorrance 公式，使镜射光部分不要再乘 $k_s$ 了（$k_df_d+k_sf_s \to k_df_d+f_s$）。

### Unity 中的镜射系数计算

<https://community.arm.com/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-20-66/siggraph2015_2D00_mmg_2D00_renaldas_2D00_notes.pdf>

Unity 中对于镜射系数的计算公式如下：

$$
\begin{aligned}
D &= \frac{a^2}{((H \cdot N)^2(a^2-1)+1)^2} \\
\\
G*F &= \frac{1}{(L \cdot H)^2(a+0.5)}\\
\\
f_s &= \frac{D * G * F}{4}
\end{aligned}
$$

其中 $D$ 就是 $D_{GGX}$ 方法，但去掉了用于归一化的 $\pi$ ，使画面更亮。

$G*F$ 是拟合的近似公式。在原始公式中，$G$ 使用的是 $G_{SKSm}$，但 $F$ 的公式不清楚，因为原始公式和最终公式的效果并不相同。

$(N \cdot L)(N \cdot V)$被从分子分母中约分以加快速度。

## 基于图片的渲染（IBL）

上述 CookTorrance 公式中还缺少环境光的处理，在 PBR 中环境光是用 IBL 实现的。

IBL 中由于光来自一个完整的球面，因此需要对球面积分计算，但这样工作量太大了。考虑到物体表面受到的环境光不会改变，因此可以提前预处理，将部分光照提前计算存放到环境贴图中。因此对于间接光，不能直接使用直接光的反射率方程。

在Unity中：预计算的漫射光使用SH存储；镜射光使用立方体纹理存储，并根据不同粗糙度存储了多份放在了mipmap中。

漫射光最简单，从SH中取出的就是辐射率，直接乘上漫射的反射率即可。镜射光则需要根据不同的粗糙度采样不同mipmap的立方体贴图来获得进行一定处理后的辐射率，然后乘上反射衰减和高光颜色。

```hlsl
float3 GlobalIlluminationDiffuse_Unity(float3 n, float3 diffuse)
{
    half3 radiance = SampleSH(n);

    return diffuse * radiance;
}

float3 GlobalIlluminationSpecular_Unity(float3 n, float3 v, float3 specular, float metallic, float perceptualRoughness, float roughness, float roughness2)
{
    float3 radiance = GlossyEnvironmentReflection(reflect(-v, n), perceptualRoughness, 1);

    //反射衰减（确保能量守恒）
    float surfaceReduction = 1.0 / (roughness2 + 1.0);

    //镜射光反射率
    float fresnel = Pow4(1.0 - saturate(dot(n, v))); //菲涅尔效应导致光全反射
    float ks = lerp(0.04, 1, metallic); //镜射率
    specular = lerp(specular, saturate(ks + roughness), fresnel);

    return specular * radiance * surfaceReduction;
}
```

## 参考资料

- <https://graphicscompendium.com/gamedev/15-pbr>
- <https://zhuanlan.zhihu.com/p/33464301>
