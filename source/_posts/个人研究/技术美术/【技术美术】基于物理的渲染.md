# 【技术美术】基于物理的渲染

## CookTorrance

CookTorrance 是一种基于物理的光照模型，相比过去的一些经验模型，它的效果更加真实，符合物理规律。CookTorrance 中有很多过去 Lambert 和 Phong 的影子，可以说就是由它们为基础慢慢发展出的新时代光照模型，也是目前主流的光照模型。

### 基本公式结构

基本的 CookTorrrance 光照模型结构如下：

- 灯光信息
  - $k_d$：表面对每单位漫射光的反射率（不考虑衰减）。
  - $k_s$：表面对每单位镜射光的反射率（不考虑衰减）。
  - $i_{m}$：表面接收到的灯光 m 的光（不考虑角度衰减）。
- 方向信息
  - $N$：表面法线。
  - $V$：表面到相机方向。
  - $L_m$：表面到灯光 m 的方向。

$$
CookTorrance = \sum_{m} i_{m}*(L_m \cdot N)(k_d + k_s * factor_s)
$$

其中 $factor_s$ 是一个需要计算的系数，也是 CookTorrance 中最重要的地方，但由于内容过多，后面再详细展开。

相比 Phong 模型，该模型除了镜射系数的区别外，其他地方都比较类似，不过漫射系数被单独提取了出来（但由于镜射系数中会除上漫射系数，实际上漫射系数依然是可以用 Phong 中的写法的，网上也有别人对此表示了困惑）。

### 高光系数计算

高光系数的计算公式如下：

$$
factor_s = \frac{D*G*F}{4}
$$

在部分资料中该公式可能还有额外的分母系数 $(N \cdot L_m)*(N \cdot V)$，不过由于这部分可以被 $G$ 中的分子约分，因此实际使用中会省略这部分。（但如果不去除的话，可以确保 $G \in [0,1]$，直观上看，这样会更能表现公式的物理效果）

其中 D、G、F 是三个可插拔的系数，用于反应 3 种物理现象。可插拔意味着它们是可以更换的，有多种计算方式可供选择，因此可以以此实现渲染效果的定制。

#### 法线分布

D 描述表面法线分布情况，具体而言它决定了镜面高光的光斑形状。下述是使用 GGX 计算 D 的方法：

- $H=\operatorname{normalize}(L_m+V)$：半角向量的缩写。
- $a$：表面粗糙度。

$$
D_{GGX} = \frac{a^2}{\pi((H\cdot N)^2(a^2-1)+1)^2}
$$

其中 $\pi$ 是为了归一化，使其光亮的总和符合能量守恒，但有些地方（如 Unity）会故意去掉该项。

#### 几何遮蔽

G 用于表现微表面之间的遮挡导致的光线衰减现象，这在粗糙的表面尤为明显。下述是使用 Smith 计算 G 的方法：

$$
G_{Smith} = \frac{1}{lerp(N \cdot L,1,k)} *\frac{1}{lerp(N \cdot V,1,k)}
$$

$$
k=\frac{(a+1)^2}{8}（直接光） 或 \frac{a^2}{2}（间接光）
$$

从中可以观察到:

- 光线入射角或观察角度与表面越垂直，光线被遮挡的概率越小。
- 越光滑的表面，光线被遮挡的概率越小。
- 对于直接光始终会被吸收一部分，而环境光可以全反射。

此外还有一种效果接近，但性能更好的方法：

$$
G_{SKSm}=\frac{1}{lerp((L \cdot H)^2,1,a)}
$$

#### 菲涅尔效应

F 表示一个 0-1 的光线反射率，反应的是现实中的菲涅尔效应，描述了不同折射率的物体在不同观察角度下反射光线不同的特点。一般它的公式采用如下近似值：

$$
F = lerp((1-(V \cdot N))^5,1,F_0)
$$

$$
F_0 = \frac{(r-1)^2}{(r+1)^2}
$$

- $F_0$：法向反射率。
- $r$：折射率。

从中可以观察到以下几种现象：

- 折射率越高，菲涅尔效应越明显（如水面）。
- 菲涅尔效应发生时，物体正面反射光线少（能透过湖面看到底），掠角反射光线多（湖面变不透明）。
- 折射率为 0，没有菲涅尔效应，发生全反射。

不过上述菲涅尔公式只能用于透明物体，因为它会使物体表面反射为 0。对于不透明物体，可以需要采用另一种系数计算方法，详见“PBR 材质属性”章节。

### Unity 中的镜射系数计算

https://community.arm.com/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-20-66/siggraph2015_2D00_mmg_2D00_renaldas_2D00_notes.pdf

Unity 中对于镜射系数的计算公式如下：

$$
\begin{aligned}
D &= \frac{a^2}{((H \cdot N)^2(a^2-1)+1)^2} \\
\\
G*F &= \frac{1}{(L \cdot H)^2(a+0.5)}\\
\end{aligned}
$$

其中 $D$ 就是 $D_{GGX}$ 方法，但去掉了用于归一化的 $\pi$ ，使画面更亮。

$G*F$ 是拟合的近似公式。在原始公式中，$G$ 使用的是 $G_{SKSm}$，但 $F$ 的公式不清楚，因为原始公式和最终公式的效果并不相同。

## PBR 材质属性

CookTorrance 中的部分参数，目前无法直接获得，因为它们必须要结合专门的 PBR 材质属性来计算。PBR 材质分为两种：金属性和镜面性，它们分别从两种角度描述物体的表面属性。其中金属材质是当前主流，镜面则是过去的传统材质，故此处介绍金属材质。

金属材质会提供如下关键表面信息：

- albedo（反射率）：决定了反射光的基本颜色强度信息（可简单理解为物体表面颜色）。
- metallic（金属度）：控制漫射光和镜射光之间的比例，以及镜射光颜色。金属度越高，漫射越少，镜射越多，镜射颜色越接近物体表面颜色。
- smoothness（光滑度）：控制镜射光的形状特征。

此外还有些特殊参数：

- dielectricSpec（标准介电镜面反射）：一个定义了最大漫射比和基础高光颜色的常量，不清楚来源（应该是某种物理规则），其使得物体一定会发出一点镜射光。

  $$dielectricSpec = (0.04, 0.04, 0.04, 0.96)$$

以此便可计算公式中的那些未知参数：

- $k_d = \operatorname{lerp}(albedo * dielectricSpec.a,0,metallic)$
- $k_s = \operatorname{lerp}(dielectricSpec.rgb,albedo,metallic)$
- $a = (1-smoothness)^2$

此外金属工作流还提供了另一种计算菲涅尔系数的方法：

- $F_0 = k_s$

不过该方法将菲涅尔函数的输出由标量改为了向量，携带了镜射光的强度信息，因此要修改 CookTorrance 公式，使镜射光部分不要再乘 $k_s$ 了（$k_d+k_s * factor_s \to k_d+factor_s$）。

## 基于图片的渲染（IBL）

上述 CookTorrance 公式中还缺少环境光的处理，在 PBR 中环境光是用 IBL 实现的。

## 参考资料

- https://graphicscompendium.com/gamedev/15-pbr
- https://zhuanlan.zhihu.com/p/33464301
