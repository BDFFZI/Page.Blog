---
categories:
  - 技术堆栈
  - 技术美术
  - 渲染管线
abbrlink: 3174050793
---
# 【技术美术】GPU绘制画面的基本原理

GPU是如何在屏幕上绘制画面的？

GPU是计算机的一部分，自然是基于数学的，也只有数学能足够严谨精确的去描述画面。那问题便可以抽象为“如何用数学表示一幅2D图像？”。

## 定位画面

上过初中的都知道，直角坐标系嘛。比如我和画画的人约定好，待会他要画一个三角形，那我只要告诉他三个顶点的坐标，那他100%就能在我期望的位置画出三角形。

当然，光一个三角形太简单了，我希望有更复杂的图像咋办？俗话说的好，量变引起质变，再复杂的图像都是有由若干基础几何图形构成的，而且恰好三角形是二维图形的最基本元素（两角形就是线了，不构成二维，而四边形又可以由两个三角形构成），所以只要一次性多传一些三角形，就可以把画面堆出来了。

传了很多三角形，但发现很多三角形实际上顶点是一样的，考虑到信息沟通的效率（减少传输的信息大小），我们可以将它们合并，例如把所有顶点单独存放，然后三角形的三个顶点改为用这些顶点中的索引位置来表示。

![数学上的三角形表示](../../../../assets/images/image-16.png)

汇总一下，我们便完成了绘制画面的第一步“定位画面”，其确定的数据信息如下：

1. 需要绘制三角形
2. 顶点列表
3. 三角形索引列表

对应到GPU中，这部分由两个阶段构成：

1. 输入装配：准备三角形数据
2. 顶点着色器：定位三角形位置

其用到的数据在GPU中叫做

- 顶点缓冲区：对应顶点列表
- 索引缓冲区：对应三角形索引列表
- 管线基元类型状态：对于需要绘制三角形的设置

上述就是GPU调用渲染命令的最基本需求，此外“顶点缓冲区”和“索引缓冲区”在引擎渲染管线中通常还会被封装成名为“网格”的数据类型。

## 分配像素

![确定三角形范围内的像素](../../../../assets/images/image-17.png)

图像位置被确定后，通常就可以开始上色了，但GPU毕竟是要渲染到屏幕上。数学上的点线面是连续的，但屏幕是离散的，所以GPU在上色前，必须确定哪些像素会被用来上色。这个过程叫光栅化，是GPU自动执行的。

## 画面上色

接下来就进入上色阶段了，最简单可以直接上个纯色，但那样不够有趣。通常我们更想在绘制区域显示一张准备好的图片，于是问题就变成了“如何在三角形上显示图片？”。

如果直接给一张图片，我们自然的会将它直接贴在显示区域上，因为我们知道他们的位置关系，这一过程叫做映射。为了在数学上实现映射，我们可以再次利用坐标系，在顶点上增加一种叫uv的二维坐标，而该坐标便可以对应到图片上的具体位置。

三角形三个顶点对应的图片画面可以确定了，但他的边和面咋办？因为uv是基于线性空间的，所以可以对其进行插值操作。利用三角形重心插值算法，我们可以将三个顶点的uv坐标分配不同权重，均匀的分散到三角形内部中。当然这个过程不是上色的一部分，实际上**它自动发生在上一节的光栅化阶段**。不过因为这只是一种通用算法，遇到一些非线性的映射关系时（例如映射到圆盘模型上），还是会发生一些映射错误。

![纹理的uv映射](../../../../assets/images/image-18.png)

最终我们便可以利用每个像素上的uv，采样图片来显示想要的画面了。当然在GPU中，图片有另一个更准确的名字“纹理”。

## 输出结果

如果要绘制多次，一个像素很可能会被多次用到，因此就存在写入时，像素中已有颜色的情况，而处理这个问题的阶段，在GPU中叫“输出合并阶段”。

![输出合并](../../../../assets/images/image-19.png)

有多种方式可以处理，例如为像素增加深度信息，或提供一个掩码值，用这种方式抛弃被遮挡或指定的像素，这种方法叫“深度模板测试”；还有些是选择将已有颜色和新颜色按指定的权重系数叠加到一起，这种叫“混合”。

不管如何，颜色最终都会写入到像素，接着像素显示在显示屏中使我们可以看到画面。

## GPU的可编程性

上色是GPU渲染中最复杂的阶段，毕竟萝卜青菜各有所爱，每个人都有自己的渲染需求，因此GPU有意将这部分做成了可编程阶段，而编写出的GPU代码则叫做“着色器”。当然，GPU中有很多阶段都是支持编程的，因此上色阶段有个专属名称叫“片段着色器”或“像素着色器”。同理，定位画面在GPU中叫做“顶点着色器”。

## GPU绘制方法总结

用最简单话来描述GPU的绘制流程：

1. 资源装配阶段：准备网格数据。
2. 顶点着色器：分析网格数据确定画面在屏幕上的数学位置。
3. 光栅化：将画面的数学位置对应到具体的物理像素，并插值顶点数据。
4. 片段着色器：利用每个像素携带的数据和其他资源，进行画面上色。

GPU在屏幕上绘制一张图像就是这么简单。
