---
categories:
  - 2. 工作
  - Unity
---
# 热更新
直译过来即让代码可以像资源包一样被运行时更新。当然它其实还一个名称叫热修复，即实现不重新打包项目也能把Bug修好，哈哈。

## 原理
1. C#无法直接热更新  
C#是编译型语言，需要先编译成IL再送到虚拟机里才可运行。部分平台不支持C#编译器的使用,所以没法通过直接重新编译C#代码来实现热更新。

1. lua可以轻松热更新  
lua是解释性语言，不需要编译，直接扔个字符串也能运行，所以可以将其作为文本资源对待，更新起来非常轻松。

1. 不建议完全使用lua编程  
解释性语言执行效率低，且Unity是C#编程环境，开发和学习的难度都会大幅提升。

1. 在C#中混合lua实现热更新  
例如在每个C#函数的开头加一句判断，如果资源文件里有该函数对应的lua文件，才调用lua代码，否则说明还不需要热更新，正常调用后续的C#代码就行。这样的话只有需要修Bug的时候才要编写lua代码，否则正常情况可以一直使用C#开发。

1. 手动混合C#和lua过于麻烦  
必须要求每个函数开头都要加上一段代码，想想就可怕。这工作量太大了，如果能实现自动把这些代码写上去就好了。视觉效果也不美观，要是只在打包项目时才把这些代码加上就好了。

1. 通过Mono.Cecil实现C#库的自动修改  
C#首先会被打包成IL库，最后才被IL2CPP编译成平台代码，IL的状态下反编译非常容易。利用Mono.Cecil我们可以通过程序对这些IL库的内容进行调整，比如修改里面每个函数的代码，从而自动实现上述需求。

1. 使用Xlua实现上述需求  
Xlua已经完成了以上需求的实现，并且免费开源，我们可以直接白嫖，又有大厂加持，安全稳定，不说了开冲。

# Xlua热更新
Xlua在官方的介绍里说是为Unity增加了使用lua脚本的能力，所以他的功能其实比较多，热更新只是其中一个。在官方文档里，热更新又叫热补丁，热补丁的文档链接如下，必看。
https://github.com/Tencent/xLua/blob/master/Assets/XLua/Doc/hotfix.md

## 使用方式
（这是一个只有我能看懂的说明）
1. 安装方式不说了，直接去他的仓库看。 https://github.com/Tencent/xLua
1. 为项目添加HOTFIX_ENABLE宏，从而打开热更新功能。
1. 把所有你需要热更新的代码打上\[Hotfix\]标签，具体看文档，注意方式一高版本Unity用不了。
1. 搞个单例类，在里面开一个lua虚拟机，在里面加载一个文本文件给虚拟机。
1. 这个加载上来的文本文件就是写lua热更新代码的地方，即出了bug需要替换上的新代码。
1. lua热更新代码里主要是调用xlua.hotfix函数实现代码替换，具体看文档。
1. 点击菜单项XLua/Generate Code，然后直接打包游戏就行，Xlua会自动注入代码。

## 注意点
1. 高版本Unity中所有打标签方式都请使用文档中打\[Hotfix\]标签的方式二。
2. 使用IL2CPP时，lua中用到的类有可能会被字节代码剥离程序删除。  
IL2CPP的过程中会自动删除没有被使用无效代码，而lua中调用C#代码的方式有点类似于反射，这种间接的类型访问方式无法被IL2CPP程序识别，因而会导致相关代码被错误的剥离。推荐打上\[LuaCallCSharp\]或\[ReflectionUse\]标签来解决这个问题，这样XLua便能自动把这些类型配置为不可被剥离。
3. GenerateCode前建议先调用ClearGenerateCode，这样才能保证生成的文件确实和代码中设置的一致。

## 猜测
1. 为什么C#变C++代码后，代码结构剧变，lua也能正常调用？
C#访问函数的方式不是直接使用地址，而是先用符号(函数名)去检索地址，然后再跳转到该地址。IL2CPP中虽然C#代码被转换，但这种访问方式被保留了下来，其符号信息就存在global-metadata.dat文件中，所以lua使用C#中的名称也能正常访问。

## 总结
抛开细节不谈还是蛮简单的，不说了学lua去了。